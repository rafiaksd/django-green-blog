{% extends 'base.html' %}
{% load static %}

{% block title %}{{ blog_post.title }}{% endblock %}

{% block meta %}
<meta name="description" content="{{ blog_post.meta_description|default:blog_post.content|truncatewords:30 }}">
<meta property="og:title" content="{{ blog_post.title }}">
<meta property="og:description" content="{{ blog_post.meta_description|default:blog_post.content|truncatewords:30 }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:type" content="article">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ blog_post.title }}">
<meta name="twitter:description" content="{{ blog_post.meta_description|default:blog_post.content|truncatewords:30 }}">

<!-- IMAGE -->
 {% if blog_post.image %}
<meta property="og:image" content="{{ blog_post.image.url }}">
<meta name="twitter:image" content="{{ blog_post.image.url }}">
{% else %}
<meta property="og:image" content="{% static 'images/pg_icon.jpg' %}">
<meta name="twitter:image" content="{% static 'images/pg_icon.jpg' %}">
{% endif %}


<!-- Canonical URL -->
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Structured Data JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ blog_post.title }}",
  "image": [
    {% if blog_post.image %}
      "{{ blog_post.image.url }}"
    {% else %}
      "{% static 'images/pg_icon.jpg' %}"
    {% endif %}
  ],
  "author": {
    "@type": "Person",
    "name": "{{ blog_post.author.username }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AgriWhispers",
    "logo": {
      "@type": "ImageObject",
      "url": "{% static 'images/pg_icon.jpg' %}"
    }
  },
  "datePublished": "{{ blog_post.created_at|date:'Y-m-d' }}",
  "dateModified": "{{ blog_post.updated_at|date:'Y-m-d' }}",
  "description": "{{ blog_post.meta_description|default:blog_post.content|truncatewords:50 }}"
}
</script>

{% endblock %}


{% block content %}

<div class="mt-2 mb-4 md:mt-3 md:mb-6">
    <a href="javascript:history.back()" class="inline-block px-4 py-2 border-2 border-black bg-[#FFFF00] text-black font-semibold rounded-btn hover:bg-[#45cc5a] transition">
      &larr; Back
    </a>
  </div>

<article class="max-w-8xl w-11/12 md:w-full mx-auto p-6 bg-white neo-card">
  <h1 class="blog_title text-3xl md:text-4xl font-extrabold text-black">{{ blog_post.title }}</h1>
  <p class="text-lg text-gray-600 -mt-8 mb-4">
    Published on {{ blog_post.created_at|date:"F j, Y" }}
  </p>

  <p class="text-md text-gray-600 -mt-4 mb-2">{% if blog_post.category %}
      <span class="italic text-xl">Category:</span> 
      <a href="{% url 'category_posts' blog_post.category.slug %}" class="text-treegreen text-xl font-bold hover:text-black">
        {{ blog_post.category.name }}
      </a>
    {% endif %}</p>

  {% if blog_post.tags.exists %}
    <div class="mb-6 flex flex-wrap gap-2">
      <button class="italic text-xl">Tags: </button>
      {% for tag in blog_post.tags.all %}
        <a href="{% url 'tag_posts' tag.slug %}" class="inline-block px-2 py-1 border-2 border-black bg-treegreen text-sm md:text-xl text-black hover:bg-black hover:text-treegreen transition">
          #{{ tag.name }}
        </a>
      {% endfor %}
    </div>
  {% endif %}

  {% if blog_post.image %}
    <div class="">
      <img src="{{ blog_post.image.url }}" alt="{{ blog_post.title }}" class="w-full h-full object-cover">
    </div>
  {% endif %}

  <div class="prose prose-lg max-w-none">
    {% autoescape off %} 
      {{ blog_post.content|safe }}
    {% endautoescape %}
  </div>
</article>

<!-- Comments -->
<section class="max-w-8xl w-11/12 md:w-full mx-auto mt-10 p-6 bg-white neo-card">
  <h2 class="text-2xl md:text-3xl font-bold mb-4">Comments</h2>

  {% if user.is_authenticated %}
    <form method="post" class="mb-10 text-md md:text-xl">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="text-md md:text-xl px-4 mt-2 py-2 bg-treegreen border-2 border-black font-semibold text-black hover:bg-black hover:text-treegreen transition rounded-lg shadow-lg">
        Post Comment
      </button>
    </form>
  {% else %}
    <p class="mb-4">You must <a href="{% url 'login' %}" class="text-treegreen underline">log in</a> to comment.</p>
  {% endif %}

  {% for comment in comments %}
<div class="border-2 border-black p-4 mb-4 bg-gray-50 rounded-lg">
  <p class="text-black text-md md:text-xl">
    <strong>{{ comment.user.username }}</strong> â€” 
    <span class="text-sm md:text-lg">{{ comment.created_at|date:"M j, Y h:i A" }}</span>
  </p>
  <p class="mt-2 text-md md:text-lg">{{ comment.content }}</p>

  {% if user == comment.user %}
<div class="mt-2 flex justify-end gap-2">
  <!-- Edit Button -->
  <button class="px-4 py-1 text-sm md:text-md font-medium text-white bg-blue-500 rounded hover:bg-blue-600 transition"
          onclick="document.getElementById('edit-comment-{{ comment.pk }}').classList.toggle('hidden'); document.getElementById('delete-confirm-{{ comment.pk }}').classList.add('hidden');">
    Edit
  </button>

  <!-- Delete Button + Inline Confirmation -->
  <div class="flex flex-col">
    <!-- Delete Button -->
    <button type="button" 
            class="px-2 py-1 text-sm md:text-md font-medium text-white bg-red-500 rounded hover:bg-red-600 transition"
            onclick="document.getElementById('delete-confirm-{{ comment.pk }}').classList.toggle('hidden'); document.getElementById('edit-comment-{{ comment.pk }}').classList.add('hidden');">
      Delete
    </button>
  </div>
</div>



  <!-- Inline Delete Confirmation -->
      <div id="delete-confirm-{{ comment.pk }}" class="hidden mt-2 flex flex-col gap-2">
        <span>Are you sure you want to delete this comment?</span>
        <div class="flex gap-2">
          <form method="post" action="{% url 'delete_comment' comment.pk %}">
            {% csrf_token %}
            <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded font-semibold">Yes</button>
          </form>
          <button type="button" 
                  class="px-3 py-1 bg-gray-300 text-black rounded font-semibold"
                  onclick="document.getElementById('delete-confirm-{{ comment.pk }}').classList.add('hidden')">
            No
          </button>
        </div>
      </div>

  <!-- Inline Edit Form (hidden by default) -->
  <form method="post" action="{% url 'edit_comment' comment.pk %}" 
        id="edit-comment-{{ comment.pk }}" class="hidden mt-2">
    {% csrf_token %}
    <textarea name="content" class="w-full border rounded p-2">{{ comment.content }}</textarea>
    <div class="mt-2 flex gap-2">
      <button type="submit" class="px-3 py-1 bg-treegreen border-2 border-black rounded text-black font-semibold">
        Save
      </button>
      <button type="button" 
              onclick="document.getElementById('edit-comment-{{ comment.pk }}').classList.add('hidden')" 
              class="px-3 py-1 bg-gray-300 border-2 border-black rounded text-black font-semibold">
        Cancel
      </button>
    </div>
  </form>
{% endif %}


</div>
{% empty %}
<p class="text-gray-500">No comments yet.</p>
{% endfor %}
</section>
{% endblock %}