{% extends 'base.html' %}
{% block title %}Blog{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

  <h1 class="text-2xl md:text-3xl font-extrabold text-center -mt-8 mb-4 md:mb-6 uppercase">Blogs</h1>

 <!-- ==================== SEARCH + SHOW FILTERS ==================== -->
<div class="relative max-w-4xl mx-auto">
  <!-- Search Bar -->
  <form action="{% url 'search_posts' %}" method="get"
        class="-mt-4 text-sm mb-4 flex justify-center">
    <input type="text" name="q" value="{{ search_query|default:'' }}"
           placeholder="Search posts..."
           class="border-2 border-black px-2 py-2 md:p-4 w-3/5 md:w-1/2 focus:outline-none rounded-l-lg">
    <button type="submit"
            class="bg-treegreen border-2 border-black px-6 font-bold text-black hover:bg-black hover:text-treegreen transition rounded-r-lg border-l-0">
      Search
    </button>
  </form>

  <!-- Show more toggle -->
  <div class="text-center">
    <button type="button" id="toggle-filters"
            class="inline-block px-4 py-1 text-sm md:text-lg font-medium border-2 border-black rounded-md bg-[#fffd8d] hover:bg-treegreen transition">
      Show more filters <span class="ml-1" id="toggle-icon">▼</span>
    </button>
  </div>

  <!-- FILTERS: Use opacity + max-height, no overflow-hidden -->
<div id="filter-container"
     class="transition-all duration-500 ease-in-out max-h-0 opacity-0 pointer-events-none"
     style="max-height: 0;">
  <div class="pt-6 space-y-6">

    <!-- ==== CATEGORIES ==== -->
    <div class="text-center">
      <p class="text-xs md:text-sm font-bold uppercase text-gray-700 mb-2">
        Categories:
      </p>
      <div class="flex flex-wrap justify-center gap-x-2 gap-y-1 md:gap-x-4 md:gap-y-3">
        {% for category in categories %}
          {% if selected_category == category %}
            <a href="{% url 'blog_list' %}"
               class="border-2 border-black px-2 py-1 font-semibold bg-treegreen text-black transition rounded-lg text-xs md:text-2xl">
              {{ category.name }}
            </a>
          {% else %}
            <a href="{% url 'category_posts' category.slug %}"
               class="border-2 border-black px-2 py-1 font-semibold bg-white text-black hover:bg-treegreen transition rounded-lg text-xs md:text-2xl">
              {{ category.name }}
            </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- ==== TAGS ==== -->
    <div class="text-center">
      <p class="text-xs md:text-sm font-bold text-gray-700 mb-2">
        Tags:
      </p>
      <div class="flex flex-wrap justify-center gap-1">
        {% for tag in tags %}
          {% if selected_tag == tag %}
            <a href="{% url 'blog_list' %}"
               class="inline-block border-2 border-black px-2 py-0 font-semibold bg-treegreen rounded-md text-xs md:text-lg">
              #{{ tag.name }}
            </a>
          {% else %}
            <a href="{% url 'tag_posts' tag.slug %}"
               class="inline-block border-2 border-black px-2 py-0 font-semibold bg-white hover:bg-treegreen rounded-md text-xs md:text-lg">
              #{{ tag.name }}
            </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>

  </div>
</div>
</div>
<!-- END FILTER SECTION -->

<!-- ==================== TOGGLE SCRIPT (FIXED & SAFE) ==================== -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('toggle-filters');
    const icon = document.getElementById('toggle-icon');
    const container = document.getElementById('filter-container');

    let isOpen = false;
    let fullHeight = '500px'; // fallback

    // Measure real height
    function measureHeight() {
      container.style.maxHeight = 'none';
      container.style.opacity = '1';
      container.style.pointerEvents = 'auto';
      fullHeight = container.scrollHeight + 'px';
      if (!isOpen) {
        container.style.maxHeight = '0';
        container.style.opacity = '0';
        container.style.pointerEvents = 'none';
      }
    }

    function open() {
      measureHeight();
      container.style.maxHeight = fullHeight;
      container.style.opacity = '1';
      container.style.pointerEvents = 'auto';
      icon.textContent = '▲';
      btn.classList.remove('bg-[#fffd8d]');
      btn.classList.add('bg-treegreen');
      isOpen = true;
    }

    function close() {
      container.style.maxHeight = '0';
      container.style.opacity = '0';
      container.style.pointerEvents = 'none';
      icon.textContent = '▼';
      btn.classList.remove('bg-treegreen');
      btn.classList.add('bg-[#fffd8d]');
      isOpen = false;
    }

    // Auto-open if filtered
    const isFiltered = {{ selected_category|yesno:"true,false" }} || {{ selected_tag|yesno:"true,false" }};
    if (isFiltered) {
      open();
    }

    btn.addEventListener('click', () => {
      if (isOpen) close();
      else open();
    });
  });
</script>

<!-- No-JS fallback -->
<noscript>
  <style>
    #filter-container {
      max-height: none !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }
    #toggle-filters { display: none; }
  </style>
</noscript>

  <!-- =============== PAGINATION (MOVED OUTSIDE FILTER) =============== -->
  {% if page_obj.has_other_pages %}
    <div class="flex text-xs md:text-lg justify-center my-6 md:my-8 space-x-2">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" 
           class="border-2 border-black px-4 py-2 font-bold bg-white hover:bg-treegreen">Prev</a>
      {% endif %}
      <span class="px-4 py-2 border-2 border-black bg-treegreen text-black font-bold">{{ page_obj.number }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" 
           class="border-2 border-black px-4 py-2 font-bold bg-white hover:bg-treegreen">Next</a>
      {% endif %}
    </div>
  {% endif %}

  <!-- Blog Posts -->
  <div class="flex flex-col gap-10">
    {% for post in page_obj %}
      <div class="neo-card bg-white p-4 md:p-6 rounded-lg flex flex-col xl:flex-row {% if forloop.counter|divisibleby:2 %}xl:flex-row-reverse{% endif %} items-center gap-6">
        {% if post.image %}
          <div class="">
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="w-full h-full object-cover">
          </div>
        {% endif %}

        <div class="flex-1 text-left">
          <h2 class="text-2xl md:text-5xl font-bold -mt-4 md:mt-0 md:mb-2 text-black">
            <a href="{% url 'blog_detail' post.slug %}" class="hover:underline">{{ post.title }}</a>
          </h2>
          <p class="text-sm md:text-lg text-gray-500 font-bold">{{ post.created_at|date:"F j, Y" }}</p>
          
          {% if post.category %}
            <p class="text-sm md:text-lg text-gray-600 mb-2">
              Category: 
              <a href="{% url 'category_posts' post.category.slug %}" class="text-treegreen hover:text-black font-semibold">
                {{ post.category.name }}
              </a>
            </p>
          {% endif %}
          
          <p class="text-gray-700 text-md md:text-xl line-clamp-6 md:line-clamp-8 mb-4">{{ post.content|striptags|truncatewords:100|safe }}</p>
          <a href="{% url 'blog_detail' post.slug %}"
             class="inline-block px-4 py-2 bg-treegreen border-2 border-black text-black font-medium hover:bg-black hover:text-treegreen transition">
            Read More
          </a>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-gray-500">No posts found.</p>
    {% endfor %}
  </div>

  <!-- Bottom Pagination (duplicate removed, use only one) -->
  {% if page_obj.has_other_pages %}
    <div class="flex justify-center mt-10 space-x-2">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" 
           class="border-2 border-black px-4 py-2 font-bold bg-white hover:bg-treegreen">Prev</a>
      {% endif %}
      <span class="px-4 py-2 border-2 border-black bg-treegreen text-black font-bold">{{ page_obj.number }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" 
           class="border-2 border-black px-4 py-2 font-bold bg-white hover:bg-treegreen">Next</a>
      {% endif %}
    </div>
  {% endif %}

</div>
{% endblock %}